logs:
  crds:
    create: false
  lokiEndpoint: "http://loki-gateway.loki/loki/api/v1/push"
  extraProcessStages: ""
  # extraProcessStages: |
  #   stage.multiline {
  #     firstline     = "^[^\\s].*\\d{2}:\\d{2}:\\d{2},\\d{3}"
  #     max_wait_time = "5s"
  #     max_lines     = 5000
  #   }

  alloy:
    configMap:
      create: true
      content: |
        logging {
          level  = "warn"
          format = "json"
        }

        discovery.kubernetes "kubernetes_pods" {
          role = "pod"
          selectors {
            role  = "pod"
            field = "spec.nodeName=" + sys.env("HOSTNAME")
          }
        }

        discovery.relabel "kubernetes_pods" {
          targets = discovery.kubernetes.kubernetes_pods.targets

          rule {
            source_labels = ["__meta_kubernetes_pod_controller_name"]
            regex         = "([0-9a-z-.]+?)(-[0-9a-f]{8,10})?"
            target_label  = "__tmp_controller_name"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name", "__meta_kubernetes_pod_label_app", "__tmp_controller_name", "__meta_kubernetes_pod_name"]
            regex         = "^;*([^;]+)(;.*)?$"
            target_label  = "app"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_instance", "__meta_kubernetes_pod_label_instance"]
            regex         = "^;*([^;]+)(;.*)?$"
            target_label  = "instance"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_component", "__meta_kubernetes_pod_label_component"]
            regex         = "^;*([^;]+)(;.*)?$"
            target_label  = "component"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_node_name"]
            target_label  = "node_name"
          }

          rule {
            source_labels = ["__meta_kubernetes_namespace"]
            target_label  = "namespace"
          }

          rule {
            source_labels = ["namespace", "app"]
            separator     = "/"
            target_label  = "job"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_name"]
            target_label  = "pod"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_container_name"]
            target_label  = "container"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
            separator     = "/"
            target_label  = "__path__"
            replacement   = "/var/log/pods/*$1/*.log"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash", "__meta_kubernetes_pod_annotation_kubernetes_io_config_hash", "__meta_kubernetes_pod_container_name"]
            regex         = "true/(.*)"
            replacement   = "/var/log/pods/*$1/*.log"
            separator     = "/"
            target_label  = "__path__"
          }
        }

        local.file_match "kubernetes_pods" {
          path_targets = discovery.relabel.kubernetes_pods.output
        }

        local.file_match "all_container_logs" {
          path_targets = [{
            __path__ = "/var/log/containers/*.log",
          }]
        }

        loki.source.file "kubernetes_pods" {
          targets       = array.concat(local.file_match.kubernetes_pods.targets, local.file_match.all_container_logs.targets)
          forward_to    = [loki.process.kubernetes_pods.receiver]
          tail_from_end = true
        }

        loki.process "kubernetes_pods" {
          forward_to = [loki.write.default.receiver]
          stage.cri { }
          {{- if .Values.extraProcessStages }}
          {{- .Values.extraProcessStages | nindent 2 }}
          {{- end }}
        }

        loki.write "default" {
          endpoint {
            url = {{ .Values.lokiEndpoint | quote }}
          }
        }

    mounts:
      varlog: true
    resources:
      requests:
        cpu: "10m"
        memory: "45Mi"
        ephemeral-storage: "100Mi"
      limits:
        cpu: "500m"
        memory: "500Mi"
        ephemeral-storage: "50Gi"
    livenessProbe:
      httpGet:
        path: /-/healthy
        port: 12345
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    enableHttpServerPort: false
    enableReporting: false

  service:
    enabled: false

  serviceAccount:
    create: true

  configReloader:
    enabled: false

  networkPolicy:
    enabled: true
    policyTypes:
      - Ingress
      - Egress
    ingress: []
    egress:
      - ports:
          - port: 53
            protocol: UDP
          - port: 53
            protocol: TCP
        to:
          - namespaceSelector:
              matchLabels:
                kubernetes.io/metadata.name: kube-system
      - ports:
          - port: 80
            protocol: TCP
          - port: 8080
            protocol: TCP
        to:
          - namespaceSelector: {}
            podSelector:
              matchLabels:
                app.kubernetes.io/name: loki
                app.kubernetes.io/component: gateway

  controller:
    type: "daemonset"
    replicas: 1
    priorityClassName: "alloy"
    tolerations:
      - effect: NoSchedule
        operator: Exists
