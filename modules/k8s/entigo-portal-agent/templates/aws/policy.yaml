{{- if eq .Values.global.cloudProvider "aws" }}
apiVersion: iam.aws.upbound.io/v1beta1
kind: Policy
metadata:
  name: {{ .Release.Name }}
  annotations:
    crossplane.io/external-name: "{{ .Release.Name }}"
    argocd.argoproj.io/sync-wave: '-2'
spec:
  forProvider:
    tags:
      created-by: "entigo-infralib"
    policy: |
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Action": [
                    "ecr:GetRegistryPolicy",
                    "ecr:DescribeImageScanFindings",
                    "ecr:GetLifecyclePolicyPreview",
                    "ecr:GetDownloadUrlForLayer",
                    "ecr:DescribeRegistry",
                    "ecr:DescribeImageReplicationStatus",
                    "ecr:GetAuthorizationToken",
                    "ecr:ListTagsForResource",
                    "ecr:BatchGetRepositoryScanningConfiguration",
                    "ecr:GetRegistryScanningConfiguration",
                    "ecr:BatchGetImage",
                    "ecr:DescribeImages",
                    "ecr:DescribeRepositories",
                    "ecr:BatchCheckLayerAvailability",
                    "ecr:GetRepositoryPolicy",
                    "ecr:GetLifecyclePolicy"
                  ],
                  "Effect": "Allow",
                  "Resource": "*"
              },
              {
                      "Action": [
                              "events:DescribeRule",
                              "events:PutRule",
                              "events:PutTargets",
                              "events:ListTargetsByRule"
                      ],
                      "Effect": "Allow",
                      "Resource": "*"
              },
              {
                  "Action": [
                      "sqs:DeleteMessage",
                      "sqs:ReceiveMessage"
                  ],
                  "Effect": "Allow",
                  "Resource": "arn:aws:sqs:{{ .Values.global.aws.region }}:{{ .Values.global.aws.account }}:*"
              },
              {
                  "Action": "sts:AssumeRole",
                  "Effect": "Allow",
                  "Resource": "arn:aws:iam::{{ .Values.global.aws.account }}:role/{{ .Release.Name }}-ecr-push"
              }
          ]
      }
  providerConfigRef:
    name: {{ .Values.global.providerConfigRefName }}
---
apiVersion: iam.aws.upbound.io/v1beta1
kind: Policy
metadata:
  name: {{ .Release.Name }}-ecr-push
  annotations:
    crossplane.io/external-name: "{{ .Release.Name }}-ecr-push"
    argocd.argoproj.io/sync-wave: '-2'
spec:
  forProvider:
    tags:
      created-by: "entigo-infralib"
    policy: |
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Effect": "Allow",
                  "Action": [
                      "ecr:BatchGetImage",
                      "ecr:GetDownloadUrlForLayer",
                      "ecr:CompleteLayerUpload",
                      "ecr:UploadLayerPart",
                      "ecr:InitiateLayerUpload",
                      "ecr:BatchCheckLayerAvailability",
                      "ecr:PutImage"
                  ],
                  "Resource": "arn:aws:ecr:{{ .Values.global.aws.region }}:{{ .Values.global.aws.account }}:repository/*"
              },
              {
                  "Effect": "Allow",
                  "Action": [
                      "ecr:GetAuthorizationToken"
                  ],
                  "Resource": "*"
              }
          ]
      }
  providerConfigRef:
    name: {{ .Values.global.providerConfigRefName }}
{{- end }}
